angular.module("PaperUI").directive("multiSelect",["$filter",function(e){return{restrict:"A",link:function(e,t,r){function a(t){var r=$.grep(e.parameter.options,function(e){return e.value==t});return 0==r.length?(e.parameter.optionList.push({value:t,label:t+""}),t):r.length>0?r[0].label:""}function n(){for(var t=0;t<e.parameter.options.length;t++){var r="item"==e.parameter.context?e.parameter.options[t].name:"thing"==e.parameter.context?e.parameter.options[t].UID:e.parameter.options[t].value,a=i(e.parameter.optionList,r);a==-1&&(a=e.parameter.optionList.length),e.parameter.optionList[a]={value:r,label:e.parameter.options[t].label+""}}}function i(e,t){for(var r=0;r<e.length;r++)if(e[r].value==t)return r;return-1}e.parameter.optionList=[];var o=[],l=[];if(e.isNullSelected=!1,e.configuration[e.parameter.name])if(Array.isArray(e.configuration[e.parameter.name]))for(var p=0;p<e.configuration[e.parameter.name].length;p++){var u=a(e.configuration[e.parameter.name][p]);u&&l.push(u)}else{var u=a(e.configuration[e.parameter.name]);u&&l.push(u)}$(document).bind("click",function(e){var r=$(e.target);r.parents().hasClass("dropdown")||t.find("dd ul").hide()}),t.find("dd ul li a").on("click",function(e){t.find("dd ul").hide()}),e.openDropdown=function(e){e.stopImmediatePropagation();var r=t.find("dd ul").is(":visible");angular.element(document).find("dd ul").hide(),r?t.find("dd ul").slideUp("fast"):t.find("dd ul").slideDown("fast")},e.addItemToList=function(t){var r=$.grep(e.parameter.optionList,function(t){return t.value==e.parameter.filterText}).length>0;r||(e.parameter.filterText&&e.parameter.optionList.push({value:e.parameter.filterText,label:e.parameter.filterText}),e.updateInConfig(e.parameter.filterText),e.parameter.filterText=""),t.preventDefault()},e.onEnterPress=function(r){(0==e.parameter.options.length||e.parameter.options.length>0&&!e.parameter.limitToOptions)&&13==r.keyCode&&e.addItemToList(r),setTimeout(function(){t.find("dd ul").slideDown("fast")}),r.stopImmediatePropagation()},e.searchInConfig=function(t){if(t){if(e.configuration&&e.configuration[e.parameter.name]){if(Array.isArray(e.configuration[e.parameter.name])&&e.configuration[e.parameter.name].indexOf(t)!==-1)return!0;if(e.configuration[e.parameter.name]==t)return!0}return!1}return e.isNullSelected},e.updateInConfig=function(r,a){if(void 0!=r&&null!=r&&(r=""+r),a=a?a:r,e.parameter.multiple&&e.configuration&&!e.configuration[e.parameter.name]&&(e.configuration[e.parameter.name]=[]),r)if(this.searchInConfig(r)){var n=e.configuration[e.parameter.name].indexOf(r);if(n!=-1){Array.isArray(e.configuration[e.parameter.name])?e.configuration[e.parameter.name].splice(n,1):e.configuration[e.parameter.name]="";var i=l.indexOf(a);i!=-1&&l.splice(i,1)}}else Array.isArray(e.configuration[e.parameter.name])?e.configuration[e.parameter.name].push(r):(e.configuration[e.parameter.name]=r,l=[]),e.isNullSelected=!1,l.push(a);else e.parameter.multiple||(e.configuration[e.parameter.name]="",e.isNullSelected?e.isNullSelected=!1:e.isNullSelected=!0);e.parameter.multiple||t.find("dd ul").slideUp("fast")},e.$watch("parameter.options",function(){"$promise"in e.parameter.options?e.parameter.options.$promise.then(function(){n()}):n()}),e.$watch("parameter.filterText",function(){if(e.parameter.optionList&&e.parameter.optionList.length>0){o=0==o.length?e.parameter.optionList:o;for(var t=0;t<e.parameter.optionList.length;t++)i(o,e.parameter.optionList[t].value)==-1&&o.push({value:e.parameter.optionList[t].value,label:e.parameter.optionList[t].label+""});var r=$.grep(o,function(t){var r=(t.label+"").toLowerCase();return r.indexOf((""+e.parameter.filterText).toLowerCase())!=-1});e.parameter.optionList=r&&r.length>0?r:o}}),e.getPlaceHolderText=function(e,t){return e[t.name]&&(""+e[t.name]).length>0?"thing"==t.context||"item"==t.context?1==e[t.name].length?"1 option selected":e[t.name].length+" options selected":l.toString():0==t.options.length||t.options.length>0&&!t.limitToOptions?"Add or search":"Search"},t.find(".multiList").on("mousewheel",function(e){var t=e.originalEvent,r=t.wheelDelta||-t.detail;this.scrollTop+=5*(r<0?1:-1),e.preventDefault()})}}}]).directive("selectValidation",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,a){e.$watch(r.ngModel,function(e){(void 0===e||""===e||Array.isArray(e)&&0==e.length)&&"true"==r.selectValidation?(t.addClass("border-invalid"),a.$setValidity("required",!1)):(t.removeClass("border-invalid"),a.$setValidity("required",!0))},!0)}}});